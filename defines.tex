% Font setup for LuaLaTeX - Palatino with Noto Mono for code
\usepackage{fontspec}
\usepackage{unicode-math}
\usepackage{microtype}
\usepackage{tabularray}
\usepackage{fp}
\usepackage{mathtools}
\usepackage{subcaption}
\usepackage[usenames,dvipsnames,table]{xcolor} % Allows the definition and use of colors. This package has to be included before tikz.
\usepackage{nag}       % Issues warnings when best practices in writing LaTeX documents are violated.
\usepackage{todonotes} % Provides tooltip-like todo notes.
\usepackage[acronym,toc]{glossaries} % Enables acronyms
\usepackage{xspace} % automatic space after user defined commands
\usepackage[normalem]{ulem}
\usepackage{listings} % source code listings
\usepackage{mwe} % placeholder images
\usepackage{tikz}
\usepackage{circledsteps}
\usepackage[latex=false]{svg}
\usepackage{xifthen}% provides \isempty test
\usepackage{placeins}
\usepackage{float} % provides [H] placement specifier for exact figure positioning
\usepackage{iftex}
\usepackage[framemethod=tikz]{mdframed}
\usepackage{siunitx}
\usepackage{pgfplots}
\usepackage{textgreek}
\usepackage{xparse} % <-- Add this package
\usepackage{luacode}
\usepackage{pgfplotstable}
\usepackage{pdflscape}
\usepackage{rotating}
% amssymb not needed — unicode-math provides the same symbols

% Check Python version compatibility for minted/latexminted
% Python 3.14+ has breaking changes in argparse that break latexminted
\begin{luacode}
	local handle = io.popen("python3 --version 2>&1")
	if handle then
	local result = handle:read("*a")
	handle:close()
	local major, minor = result:match("Python ([0-9]+)%.([0-9]+)")
	if major and minor then
	major, minor = tonumber(major), tonumber(minor)
	if major >= 3 and minor >= 14 then
	tex.error("Python " .. major .. "." .. minor .. " detected but latexminted requires Python < 3.14. Fix: brew unlink python@3.14")
	end
	end
	end
\end{luacode}

\usepackage[newfloat,cachedir=minted-cache]{minted}
\usepackage{booktabs}
\usepackage{csquotes}
\usepackage[most]{tcolorbox}
\usepackage{pifont}
\usepackage[pdfpagelabels,hidelinks,pdfusetitle]{hyperref}
\pdfstringdefDisableCommands{%
    \def\gls#1{#1}%
    \def\glspl#1{#1s}%
    \def\Gls#1{#1}%
    \def\Glspl#1{#1s}%
    \def\glsfirst#1{#1}%
}
\usepackage{bookmark}
\usepackage{multirow}
\sisetup{round-mode=places,round-precision=3,round-pad=false,group-minimum-digits=4,group-separator={,},scientific-notation=fixed}
\usepackage{array}
\UseTblrLibrary{booktabs,functional}
\usepackage{tabularx}
\usepackage[htt]{hyphenat}
\usepackage{collcell}   % To capture cell content
\usepackage{makecell}

% --- FLOAT TUNING START ---
% Encourage floats to be placed on the page where they are defined
\renewcommand{\topfraction}{0.85}
\renewcommand{\bottomfraction}{0.85}
\renewcommand{\textfraction}{0.1}
\renewcommand{\floatpagefraction}{0.75}
\setcounter{topnumber}{5}
\setcounter{bottomnumber}{5}
\setcounter{totalnumber}{10}
% --- FLOAT TUNING END ---

% Cleveref - must be loaded after hyperref
\usepackage[capitalize,noabbrev,nameinlink]{cleveref}

% Enumitem for inline lists
\usepackage[inline]{enumitem}

\setmainfont{TeX Gyre Pagella}
\setmathfont{TeX Gyre Pagella Math}
\setmonofont{Noto Sans Mono}[Scale=0.9]

\hyphenation{
  mis-com-pi-la-tions
  mis-com-pi-la-tion
  poly-mor-phic
  opti-mi-za-tions
  opti-mi-za-tion
}

\sisetup{round-mode=places,round-precision=3,round-pad=false,group-minimum-digits=4,group-separator={,},scientific-notation=fixed}
\UseTblrLibrary{booktabs,functional}
\usetikzlibrary{arrows.meta,arrows,automata,positioning,tikzmark,decorations.pathreplacing,backgrounds,calc}
%\usetikzlibrary{external}
%\tikzexternalize[prefix=figures/tikz-ext/]
%\DeclareUnicodeCharacter{2212}{−}
\usepgfplotslibrary{groupplots,dateplot}
\usetikzlibrary{patterns,shapes.arrows, arrows.meta, matrix}
\pgfplotsset{compat=newest}

% Fix for duplicate bars in legend entries (matplot2tikz issue with ybar legend)
% Redefines ybar legend to show only one bar instead of two (bigger + smaller)
\pgfplotsset{
	/pgfplots/ybar legend/.style={
			/pgfplots/legend image code/.code={
					\draw[##1,/tikz/.cd,yshift=-0.25em]
					(0cm,0cm) rectangle (3pt,0.8em);
				},
		},
}

\pgfplotsset{every axis/.append style={
			scaled y ticks = false,
			scaled x ticks = false,
			y tick label style = {/pgf/number format/fixed},
			x tick label style = {/pgf/number format/fixed},
			legend style={font=\small}
		}}

\lstset{language=C++,
	keywordstyle={\bfseries\color{RoyalBlue}},
	basicstyle=\small\ttfamily,
	commentstyle=\color{ForestGreen}\ttfamily,
	rulecolor=\color{black},
	upquote=true,
	numberstyle=\tiny\color{gray},
	stepnumber=1,
	numbersep=8pt,
	showstringspaces=false,
	breaklines=true,
	frame=single,
	%belowcaptionskip=3mm,
	tabsize=4,
	captionpos=b
	%escapechar=\@
}

\lstdefinestyle{sidebyside}
{
	basicstyle=\small\ttfamily,
	framexleftmargin=3pt,
	xleftmargin=8pt,
	numbersep=-4pt,
}


\definecolor{set1red}{RGB}{228, 26, 28}
\definecolor{set1green}{RGB}{77, 175, 74}
\definecolor{set1violet}{RGB}{152, 78, 163}
\definecolor{set1orange}{RGB}{255, 127, 0}

\lstdefinestyle{asmcode}{
	language={[x86masm]Assembler},
	escapechar=|
	,
	frame=none,
	keywordstyle={\bfseries\color{RoyalBlue}},
	basicstyle=\small\ttfamily,
	commentstyle=\color{ForestGreen}\ttfamily,
	rulecolor=\color{black},
	upquote=true,
	numberstyle=\tiny\color{gray},
	stepnumber=1,
	numbersep=8pt,
	showstringspaces=false,
	breaklines=true,
	%belowcaptionskip=3mm,
	tabsize=4,
	captionpos=b,
	morekeywords={vmovdqa,vmovdqu,vzeroupper},
}

\lstdefinestyle{coloredrads}{
	keywords=[2]{BTRA1},
	keywords=[3]{BTRA2},
	keywords=[4]{BTRA3},
	keywords=[5]{BTRA3},
	keywordstyle=[2]{\color{set1red}},
	keywordstyle=[3]{\color{set1green}},
	keywordstyle=[4]{\color{set1violet}},
	keywordstyle=[5]{\color{set1orange}},
}

\AtBeginDocument{\DeclareCaptionSubType{lstlisting}}

\makeatletter
\newcommand{\closepart}{
	\begingroup
	% Prevent \part* from forcing a page break
	\let\clearpage\relax
	\let\cleardoublepage\relax
	% Start an unnumbered, empty part:
	% - no page
	% - no TOC entry
	% - but it resets the “current part” state / marks
	\part*{}
	\endgroup
}
\makeatother

\newcommand{\sbrtodo}[1]{\todo[inline,color=NavyBlue!80,textcolor=white]{sbr: #1}}
\newcommand{\fbetodo}[1]{\todo[inline,color=ForestGreen!80,textcolor=white]{fbe: #1}}



\newcommand{\includetimed}[1]{
	\timerstart{#1}%
	\include{#1}%
	\timerprint{#1}%
}


% --- helpers you likely already have ---
\newsavebox{\drawioMacroBox}
\newdimen\drawioTargetWidth

% --- main macro (Lua-driven) ---
\makeatletter
\DeclareDocumentCommand{\includeDrawioFigure}{ O{\textwidth} m O{} +m }{
	% #1 target width (TeX dimen, default \textwidth)
	% #2 base name (expects #2.pdf, #2-defs.tex, #2-coords.tex)
	% #3 tikz options
	% #4 overlay tikz code

	% typeset the PDF into a box so we can measure it
	        \savebox{\drawioMacroBox}{\includegraphics[width=#1]{#2.pdf}}%
	        \input{#2-defs.tex}% defines \drawionativewidthpx, \drawionativeheightpx
	        % capture target width as a dimen
	        \drawioTargetWidth=#1\relax%
	        % the formatter gets confused with the braces in the lua code
	        % @formatter:off
	        \directlua{
	                local function sp_to_pt(sp) return sp/65536.0 end
	                local function pt_to_bp(pt) return pt * 72.0 / 72.27 end
	                local w_bp = pt_to_bp(sp_to_pt(\number\wd\drawioMacroBox))
	                local h_bp = pt_to_bp(sp_to_pt(\number\ht\drawioMacroBox))
	                local nat_w = \drawionativewidthpx
	                local nat_h = \drawionativeheightpx
	                local xbp = w_bp / nat_w
	                local ybp = h_bp / nat_h
	                tex.sprint("\\def\\drawioXbp{" .. xbp .. "}\\def\\drawioYbp{" .. ybp .. "}")
	        }%
	                \begin{tikzpicture}[x=\drawioXbp bp, y=\drawioYbp bp, #3]
	                        \useasboundingbox (0,0) rectangle (\drawionativewidthpx, \drawionativeheightpx);%
	                        \node[anchor=south west, inner sep=0] at (0,0) {\usebox{\drawioMacroBox}};%
	                        \input{#2-coords.tex}%
	                        #4%
	                \end{tikzpicture}%	% @formatter:on
}
\makeatother

\newcommand{\elbow}[3][0.5]{($ (#2)!#1!(#3) $)}
\newcommand{\specPerfAvg}{1.006$\times$}
\newcommand{\specQuantRetAddr}{70\%}
\newcommand{\wox}{W$\oplus$X\xspace}
\newcommand{\plusplus}{\texorpdfstring{\nolinebreak\hspace{-.02em}\raisebox{.1ex}{\small +}\nolinebreak\hspace{-.10em}\raisebox{.1ex}{\small +}}{++}\xspace}
\newcommand{\cpp}{C\plusplus}
\newcommand{\maxoverheadcfs}{3.61\%\xspace}
\newcommand{\geomeancfs}{0.79\%\xspace}
%\newcommand{\geomeanonlylib}{1.02\%\xspace}
\newcommand{\geomeannobt}{2.44\%\xspace} % geometric mean overhead when moving only the stack pointer
\newcommand{\avxomnetppimprov}{14\%\xspace} % improvvement in absolute percent points of omnetpp with AVX2
\newcommand{\hardenedheapbtsoverhead}{2\%\xspace} % overhead in absolute percent points of hardened heap booby traps compared to regular heap booby traps
\newcommand{\meanpercentcodepointers}{97\%}
\newcommand{\protectedcodepointers}{93\%}
\newcommand{\heapbtgeomean}{1.59\%\xspace}
\newcommand{\allprotectionsgeomean}{7.48\%\xspace}
\newcommand{\allprotectionspushgeomean}{12.47\%\xspace}
\newcommand{\allprotectionshardenedgeomean}{9.89\%\xspace}
%\newcommand{\adaptivepronegeomean}{4.19\%\xspace}
%\newcommand{\adaptiveprtwogeomean}{7.19\%\xspace}
\newcommand{\eg}{e.g.,~}
\newcommand{\ie}{i.e.,~}
\newcommand{\etal}{et al\@.\xspace}
\newcommand{\cfs}{offset-invariant addressing\xspace}
\newcommand{\Cfs}{Offset-invariant addressing\xspace}
\newcommand{\code}{\texttt}
\newcommand{\krx}{kR\^{}X\xspace}
\newcommand{\jacoco}{JaCoCo\xspace}
\newcommand{\musllib}{\propername{musl}/\propername{libc\plusplus}\xspace}
\newcommand{\glibclib}{\propername{glibc}/\propername{libstdc\plusplus}\xspace}
\newcommand*{\figuretitle}[1]{
	{\centering%   <--------  will only affect the title because of the grouping (by the
			\sffamily{\textbf{#1}}%              braces before \centering and behind \medskip). If you remove
			\par\medskip}%            these braces the whole body of a {figure} env will be centered.
}


\newcommand{\propernamedecl}{\ttfamily\hyphenchar\font=`-\relax}
\newcommand{\propername}[1]{{\propernamedecl#1}}
\newcommand{\afl}{AFL}
\newcommand{\aflpp}{AFL\plusplus}


% @formatter:off
\newcounter{rowcounter}
\setcounter{rowcounter}{0}
\newif\ifdatarows
\datarowsfalse
\newcommand{\nextrow}{\stepcounter{rowcounter}}
\newcommand{\startdatarows}{\noalign{\global\datarowstrue}}
\AtBeginEnvironment{tabular}{\setcounter{rowcounter}{0}\datarowsfalse}
\AtBeginEnvironment{tabularx}{\setcounter{rowcounter}{0}\datarowsfalse} % if you use tabularx
\AtBeginEnvironment{longtable}{\setcounter{rowcounter}{0}\datarowsfalse} % if you use longtable
\AtBeginEnvironment{tabular}{\footnotesize}
\AtBeginEnvironment{tabularx}{\footnotesize}
\AtBeginEnvironment{longtable}{\footnotesize}
\AtBeginEnvironment{tblr}{\footnotesize}
\newcolumntype{C}{S[table-format=5.0]}
\newcolumntype{O}{S[table-format=6.1, round-precision=1]}
\newcolumntype{T}{S[table-format=3.1, round-precision=1]}
% Coverage comparison table columns: Δ, Δ%, A12, p
\newcolumntype{D}{S[table-format=+4.0, retain-explicit-plus, table-number-alignment=right, group-separator={,}, group-minimum-digits=4]}  % absolute delta
\newcolumntype{R}{S[table-format=+2.1, retain-explicit-plus, table-number-alignment=right]}  % relative delta %
\newcolumntype{A}{S[table-format=1.2, table-number-alignment=right]}                         % A12 effect size
\newcolumntype{P}{S[table-format=1.3, table-number-alignment=right, table-text-alignment=right]}  % p-value
% Bug triggering table columns: instance count, TTF hours
\newcolumntype{N}{S[table-format=2.0]}                          % instances triggered (0-30)
\newcolumntype{H}{S[table-format=2.1]}                          % TTF in hours
\newcolumntype{E}{>{\ifdatarows\propernamedecl\fi\arraybackslash}l}

\definecolor{rowgray}{gray}{0.95} % A very light gray
% Cell shading for effect sizes (small/medium/large)
\definecolor{cellbetter1}{HTML}{E8F5E9} % Light green - small effect
\definecolor{cellbetter2}{HTML}{C8E6C9} % Medium green - medium effect
\definecolor{cellbetter3}{HTML}{A5D6A7} % Dark green - large effect
\definecolor{cellworse1}{HTML}{FFEBEE}  % Light red - small effect
\definecolor{cellworse2}{HTML}{FFCDD2}  % Medium red - medium effect
\definecolor{cellworse3}{HTML}{EF9A9A}  % Dark red - large effect
% Shaded cell command - just applies cellcolor, S-column handles alignment
\newcommand{\shadecell}[2]{\cellcolor{#1}#2}
\newcommand{\conditionalcell}[1]{
	\ifnum
		\value{rowcounter}=1
		% Row 1: Apply rotation
		\rotatebox[origin=bc]{45}{
			% Use [b] for bottom alignment
			% Use the new \rotHeadWidth
			\parbox[b]{3cm}{
				\propernamedecl
				\smaller
				\centering % Add this for clean line breaks
				#1%
			}
		}
	\else
		% Other rows: Just output the content
		#1%
	\fi
}

\newcolumntype{Y}{%
	>{\ifnum
				\value{rowcounter}=1
				\relax % Row 1: Don't apply \raggedright
			\else
				\raggedright % Other rows: Apply \raggedright
			\fi
			\arraybackslash     % Fix \raggedright
			\collectcell\conditionalcell % Collect the cell content
		}%
	X% Base column type
	<{\endcollectcell}%
}
% @formatter:on


\newacronym{CPH}{CPH}{Code-Pointer Hiding}
\newacronym{XOM}{XOM}{Execute-Only Memory}
\newacronym{AOCR}{AOCR}{Address-Oblivious Code Reuse}
\newacronym[plural=TLBs,firstplural=Translation Lookaside Buffers (TLBs)]{TLB}{TLB}{Translation Lookaside Buffer}
\newacronym[plural=EPTs,firstplural=Extended Page Tables (EPTs)]{EPT}{EPT}{Extended Page Table}
\newacronym{PIC}{PIC}{Position Independent Code}
\newacronym{GOT}{GOT}{Global Offset Table}
\newacronym{ROP}{ROP}{Return-Oriented Programming}
\newacronym{CFI}{CFI}{Control-Flow Integrity}
\newacronym{JITROP}{JIT ROP}{Just-In-Time Return-Oriented Programming}
\newacronym{SFI}{SFI}{Software-based Fault Isolation}
\newacronym{CFG}{CFG}{Control-Flow Graph}
\newacronym{RSB}{RSB}{Return Stack Buffer}
\newacronym{PGO}{PGO}{Profile-Guided Optimization}
\newacronym{LTO}{LTO}{Link-Time Optimization}
\newacronym{BTB}{BTB}{Branch Target Buffer}
\newacronym{PC}{PC}{Program Counter}
\newacronym{CMQ}{CMQ}{Cross-Module Quickening}
\newacronym{MVEE}{MVEE}{Multi-Variant Execution Engine}
\newacronym{PIROP}{PIROP}{Position-Independent Code Reuse}
\newacronym{CPI}{CPI}{Control-Pointer Integrity}
\newacronym{CCFI}{CCFI}{Cryptographically Enforced Control-Flow Integrity}
\newacronym{PAC}{PAC}{Pointer Authentication Code}
\newacronym{HMAC}{HMAC}{Hash-based Message Authentication Code}
\newacronym{BROP}{BROP}{Blind ROP}
\newacronym{DEP}{DEP}{Data Execution Prevention}
\newacronym{CHOP}{CHOP}{Catch Handler Oriented Programming}
\newacronym{ASLR}{ASLR}{Address Space Layout Randomization}
\newacronym{BTRA}{BTRA}{Booby-trapped return address}
\newacronym{heapbt}{BTDP}{Booby-trapped data pointer}
\newacronym{CPU}{CPU}{Central Processing Unit}
\newacronym{JITcomp}{JIT compiler}{Just-In-Time compiler}
\newacronym{JIT}{JIT}{Just-In-Time}
\newacronym{AOT}{AOT}{Ahead-Of-Time}
\newacronym{JVM}{JVM}{Java Virtual Machine}
\newacronym{SMT}{SMT}{Satisfiability Modulo Theory}
\newacronym{PSP}{PSP}{Program State Projection}
\newacronym{MLTA}{MLTA}{Multi-Level Type Analysis}
\newacronym{AIR}{AIR}{Average Indirect-target Reduction}
\newacronym{ISR}{ISR}{Instruction Set Randomization}
\newacronym{LBR}{LBR}{Last Branch Record}
\newacronym{COOP}{COOP}{Counterfeit Object-Oriented Programming}
\newacronym{BOP}{BOP}{Block-Oriented Programming}
\newacronym{TEA}{TEA}{Transient-Execution Attack}
\newacronym{COP}{COP}{Call-Oriented Programming}
\newacronym{ILR}{ILR}{Instruction-Layout Randomization}
\newacronym{IPC}{IPC}{Instructions Per Cycle}
\newacronym{VRP}{VRP}{Value-Range Partitioning}
\newacronym{TMA}{TMA}{Top-Down Microarchitectural Analysis}
\newacronym{LLM}{LLM}{Large Language Models}

\newglossaryentry{CRA}{
	name={code-reuse attack},
	plural={code-reuse attacks},
	description={An attack that reuses code already present in the target process}
}

\ifxetex
	% WORKAROUND for xelatex vs tikzmark:
	% Definition copied from /usr/share/texlive/texmf-dist/tex/generic/pgf/systemlayer/pgfsys-common-pdf-via-dvi.def
	% Compare https://tex.stackexchange.com/q/229500 and comments!
	\makeatletter
	\def\pgfsys@hboxsynced#1+{
	{% 
			\pgfsys@beginscope%
			\setbox\pgf@hbox=\hbox+{
				\hskip\pgf@pt@x%
				\raise\pgf@pt@y\hbox+{
					\pgf@pt@x=0pt%
					\pgf@pt@y=0pt%
					\special{pdf: content q}%
					\pgflowlevelsynccm%
					\pgfsys@invoke{q -1 0 0 -1 0 0 cm}%
					\special{pdf: content -1 0 0 -1 0 0 cm q}% translate to original coordinate system
					\pgfsys@invoke{0 J [] 0 d}% reset line cap and dash
					\wd#1=0pt%
					\ht#1=0pt%
					\dp#1=0pt%
					\box#1%
					\pgfsys@invoke{n Q Q Q}%
				}
				\hss%
			}
			\wd\pgf@hbox=0pt%
			\ht\pgf@hbox=0pt%
			\dp\pgf@hbox=0pt%
			\pgfsys@hbox\pgf@hbox%
			\pgfsys@endscope%
		}
	}
	\makeatother

	\newfontfamily\firasans[Path=fonts/,
		UprightFont = *-Regular,
		BoldFont = *-Bold,
		ItalicFont = *-Italic,
		BoldItalicFont = *-BoldItalic,
		FontFace={xl}{n}{*-ExtraLight},
		FontFace={xl}{it}{*-ExtraLightItalic},
		FontFace={l}{n}{*-Light},
		FontFace={l}{it}{*-LightItalic},
		FontFace={mb}{n}{*-Medium},
		FontFace={mb}{it}{*-MediumItalic},
		FontFace={k}{n}{*-Black},
		FontFace={k}{it}{*-BlackItalic},
		Extension = .ttf,
	]{FiraSans}

	\newfontfamily\firacode[Path=fonts/,
		UprightFont = *-Regular,
		BoldFont = *-Bold,
		FontFace={l}{n}{*-Light},
		FontFace={m}{n}{*-Medium},
		FontFace={sb}{n}{*-SemiBold},
		Extension = .ttf,
	]{FiraCode}

	\newcommand{\figurefont}[1]{{\sf{\firasans #1}}}%
\else
	\newcommand{\figurefont}[1]{#1}%
\fi

\newcommand*\circledtikz[1]{\tikz[baseline=(char.base)]{
		\node[shape=circle,draw,inner sep=1pt] (char) {#1};}}
\newcommand*\circleddashedtikz[1]{\tikz[baseline=(char.base)]{
		\node[shape=circle,dashed,draw,inner sep=1pt] (char) {#1};}}

\newcommand{\cnp}{\prj{}-\np{}\xspace}
\newcommand{\oapilong}{Optimization Interface\xspace}
\newcommand{\oapi}{OINT\xspace}

\newcommand{\makepropername}[2]{
	\expandafter\newcommand\csname #1\endcsname{\propername{#2}\xspace}%
	\expandafter\newcommand\csname #1noformat\endcsname{#2\xspace}%
}

\makepropername{np}{NumPy}
\makepropername{cp}{CPython}
\makepropername{npbench}{NPBench}
\makepropername{ocache}{occurence cache}
\makepropername{Ocache}{Occurence cache}

\newcommand{\cext}{C extension\xspace}
\newcommand{\cexts}{C extensions\xspace}

\newcommand{\XXX}{\fbetodo{Skipped during writing}<placeholder to be filled>}

\newcommand{\perinstrcache}{per-instruction caches\xspace}
\newcommand{\Perinstrcache}{Per-instruction caches\xspace}
\newcommand{\mwu}{Mann--Whitney~$U$\xspace}


\DeclareRobustCommand{\rtwoc}{
	\ifdefined\pdfstringdefPreHook
		% This branch is executed for PDF bookmarks and the Table of Contents.
		\texorpdfstring{R\textsuperscript{2}C}{R²C}%
	\else
		% This branch is executed for the main document text.
		\textsc{R\textsuperscript{2}C}%
	\fi
	\xspace
}


\DeclareRobustCommand{\lool}{
	\ifdefined\pdfstringdefPreHook
		% This branch is executed for PDF bookmarks and the Table of Contents.
		\texorpdfstring{LOOL}{LOOL}%
	\else
		% This branch is executed for the main document text.
		\textsc{LOOL}%
	\fi
	\xspace
}


\newlist{problems}{enumerate}{1} % also creates a counter called 'problemsi'
\setlist[problems,1]{label=\Alph*)}
\crefname{problemsi}{Problem}{Problems}

\newlist{configurations}{enumerate}{1}
\setlist[configurations,1]{
	label=\textbf{\Alph*)},     % Bold + uppercase letter + closing parenthesis
	ref=\Alph*,                 % For cleveref referencing (gives "A", "B", etc.)
}
\newcommand{\configuration}[1]{
	\item \textbf{#1}
}
\crefname{configurationsi}{Configuration}{Configurations}
% see https://github.com/matplotlib/matplotlib/issues/27907
\providecommand\mathdefault[1]{#1}


\newcounter{hypothesiscounter}
\makeatletter
\@addtoreset{hypothesiscounter}{chapter}
\makeatother
\crefname{hypothesiscounter}{Hypothesis}{Hypotheses}
\Crefname{hypothesiscounter}{Hypothesis}{Hypotheses}
\makeatletter
\crefformat{hypothesiscounter}{#2#1#3}
\makeatother


% 1. Define a new list environment based on 'description'
\newlist{hypotheses}{description}{1}

% 2. Configure the new list
\setlist[hypotheses]{
	font=\bfseries,
	leftmargin=2em,
	itemsep=1.5ex,
	parsep=0.5ex
}

\makeatletter
\newcommand{\hypothesis}[2][]{%
	% Step the counter. This sets \@currentlabel to the number.
	\refstepcounter{hypothesiscounter}%
	% Check if an optional label key was provided.
	\if
		\relax\detokenize{#1}\relax\else
		% Save the original \@currentlabel (the number).
		\let\original@currentlabel\@currentlabel
		% Redefine \@currentlabel to be your custom text for the label.
		\protected@edef\@currentlabel{H\thehypothesiscounter: \unexpanded{#2}}%
		% Write the label using the new, custom \@currentlabel.
		\label{#1}%
		% IMPORTANT: Restore the original \@currentlabel.
		\let\@currentlabel\original@currentlabel
	\fi
	% Now, display the item text in the list.
	\item[\textbf{H\thehypothesiscounter: #2}]\hfill\\%
}
\makeatother


% Research Questions enumeration (similar to hypotheses, for PSC evaluation)
\newcounter{researchquestioncounter}
\crefname{researchquestioncounter}{RQ}{RQs}
\Crefname{researchquestioncounter}{Research Question}{Research Questions}
\makeatletter
\crefformat{researchquestioncounter}{#2#1#3}
\makeatother

\newlist{researchquestions}{description}{1}
\setlist[researchquestions]{
	font=\bfseries,
	leftmargin=3.5em,
	labelwidth=3em,
	labelsep=0.5em,
	itemsep=1ex
}

\makeatletter
\newcommand{\researchquestion}[2][]{%
	\refstepcounter{researchquestioncounter}%
	\if
		\relax\detokenize{#1}\relax\else
		\let\original@currentlabel\@currentlabel
		\protected@edef\@currentlabel{\unexpanded{#2}}%
		\label{#1}%
		\let\@currentlabel\original@currentlabel
	\fi
	\item[\textbf{RQ#2:}]%
}
\makeatother




\newcommand*{\threeapprox}{\approx}

\newcommand{\speccpu}{SPEC CPU 2017\xspace}



\crefname{codelisting}{Listing}{Listings}
\Crefname{codelisting}{Listing}{Listings}

\crefname{enumfigure}{List}{Lists}
\Crefname{enumfigure}{List}{Lists}
\crefname{step}{Step}{Step}
\Crefname{step}{Steps}{Steps}

\DeclareFloatingEnvironment[placement={ht},name=Listing]{codelisting}
\DeclareFloatingEnvironment[placement={!ht},name=List]{enumfigure}

\newlist{inline}{enumerate*}{1}
\setlist[inline]{label=(\roman*)}
\crefname{inlinei}{item}{items}

\newlist{inlinenum}{enumerate*}{1}
\setlist[inlinenum]{label=(\arabic*)}
\crefname{inlinenumi}{item}{items}

\newlist{inlinealpha}{enumerate*}{1}
\setlist[inlinealpha]{label=(\alph*)}
\crefname{inlinealphai}{item}{items}

\newlist{inlinecircle}{enumerate*}{1}
\setlist[inlinecircle]{label=\protect\Circled{\arabic*}}
\crefname{inlinecirclei}{item}{items}

\newtcolorbox{infobox}{
	colback=black!5,      % Background color (5% black, 95% white)
	colframe=black,       % Frame color
	boxrule=1.2pt,        % Frame thickness
	%arc=3mm,              % Radius of the rounded corners
	boxsep=3pt,           % Padding between text and box
	left=8pt,            % Specific padding on the left
	right=8pt,           % Specific padding on the right
	top=8pt,              % Specific padding on the top
	bottom=8pt,           % Specific padding on the bottom
	%    breakable,            % Allows the box to break across pages
}

\numberwithin{figure}{chapter}
\numberwithin{listing}{chapter}

% Widen LoF/LoT page-number column so long captions don't push page numbers out of alignment
\makeatletter
\renewcommand{\@pnumwidth}{2.5em}
\renewcommand{\@tocrmarg}{3.5em}
\makeatother

% Inline helper: draw a tiny boxed number and mark it with a global node name.
\newcommand{\numtag}[2]{
	\tikz[remember picture,baseline=(#1.base)]%
	\node[inner sep=1pt,outer sep=0pt,draw,rounded corners=2pt,%
		font=\footnotesize] (#1) {#2};
}

\definecolor{codebackground}{HTML}{F5F5F5}
\newcommand{\mintedindent}[1]{\makebox[\MyMintedWidth][l]{\hspace{2mm}#1}}
\setminted{
	fontsize=\footnotesize,
	style=tango,
	frame=none,
	formatcom=\let\FancyVerbFormatLine\mintedindent\setlength{\fboxsep}{0pt}
}
\tcolorboxenvironment{minted}{
	enhanced,
	colback=codebackground,
	colframe=black!30,
	boxsep=0mm,
	left=0mm,
	right=0mm,
	top=2mm,
	bottom=2mm,
	arc=0mm,
	outer arc=0mm,
	before upper={\edef\MyMintedWidth{\the\linewidth}\addtolength{\linewidth}{-4mm}%
		% Redefine highlight to use MyMintedWidth for full-width background
		\def\FancyVerbHighlightLineFirst##1{%
			\hspace*{-2mm}%
			\colorbox{\FancyVerbHighlightColor}{%
				\makebox[\MyMintedWidth][l]{\hspace{2mm}\strut##1}%
			}\hss}%
		\let\FancyVerbHighlightLineSingle\FancyVerbHighlightLineFirst
		\let\FancyVerbHighlightLineMiddle\FancyVerbHighlightLineFirst
		\let\FancyVerbHighlightLineLast\FancyVerbHighlightLineFirst
	}
}
